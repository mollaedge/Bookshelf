<div class="modal-overlay" *ngIf="isOpen" (click)="close()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ modalTitle }}</h2>
      <button class="close-button" (click)="close()" aria-label="Close">&times;</button>
    </div>

    <div class="modal-body">
      <!-- Search Bar for External APIs -->
      <div class="search-section">
        <h3>Search Books Online</h3>
        <div class="search-bar">
          <input 
            type="text" 
            class="search-input"
            [(ngModel)]="searchQuery"
            (input)="onSearchInput(searchQuery)"
            placeholder="Search for books by title, author, or ISBN..."
            [disabled]="mode === 'edit'">
          <button 
            class="clear-search-btn" 
            *ngIf="searchQuery" 
            (click)="clearSearch()"
            type="button">
            √ó
          </button>
        </div>
        
        <div class="search-status" *ngIf="isSearching">
          <span class="spinner"></span> Searching...
        </div>

        <!-- Search Results -->
        <div class="search-results" *ngIf="showSearchResults && searchResults.length">
          <div class="search-results-header">
            <span>{{ firstResultIndex }}‚Äì{{ lastResultIndex }} of ~{{ totalItems }} results</span>
          </div>
          <div class="search-results-list">
            <div
              class="search-result-item"
              *ngFor="let book of searchResults"
              (click)="selectExternalBook(book)">
              <img
                [src]="book.volumeInfo.imageLinks?.thumbnail || book.volumeInfo.imageLinks?.smallThumbnail || 'assets/default-book.png'"
                [alt]="book.volumeInfo.title"
                class="result-thumbnail">
              <div class="result-info">
                <h4>{{ book.volumeInfo.title }}</h4>
                <p class="result-author">{{ book.volumeInfo.authors?.join(', ') || 'Unknown Author' }}</p>
                <p class="result-meta" *ngIf="book.volumeInfo.publishedDate">
                  {{ book.volumeInfo.publishedDate | date: 'yyyy' }}
                </p>
              </div>
              <button class="use-btn" type="button">Use This</button>
            </div>
          </div>
          <div class="search-pagination">
            <button
              class="pagination-btn"
              type="button"
              [disabled]="currentPage === 0 || isSearching"
              (click)="prevPage()">
              &lsaquo; Prev
            </button>
            <span class="pagination-info">Page {{ currentPage + 1 }} of {{ totalPages }}</span>
            <button
              class="pagination-btn"
              type="button"
              [disabled]="currentPage + 1 >= totalPages || isSearching"
              (click)="nextPage()">
              Next &rsaquo;
            </button>
          </div>
        </div>

        <div class="no-results" *ngIf="showSearchResults && !searchResults.length && !isSearching">
          No books found. Try a different search term.
        </div>
      </div>

      <div class="divider">
        <span>OR ENTER MANUALLY</span>
      </div>

      <!-- Manual Entry Form -->
      <form (ngSubmit)="onSubmit()" #formRef="ngForm">
        <div class="form-group">
          <label for="title">Title *</label>
          <input 
            type="text" 
            id="title" 
            name="title"
            [(ngModel)]="bookFormData.title" 
            required
            placeholder="Enter book title">
        </div>
        
        <div class="form-group">
          <label for="author">Author *</label>
          <input 
            type="text" 
            id="author" 
            name="author"
            [(ngModel)]="bookFormData.authorName" 
            required
            placeholder="Enter author name">
        </div>
        
        <div class="form-group">
          <label for="isbn">ISBN-13</label>
          <input 
            type="text" 
            id="isbn" 
            name="isbn"
            [(ngModel)]="bookFormData.isbn" 
            maxlength="13"
            pattern="[0-9]{13}"
            placeholder="Enter 13-digit ISBN">
        </div>
        
        <div class="form-group">
          <label for="genre">Genre</label>
          <input 
            type="text" 
            id="genre" 
            name="genre"
            [(ngModel)]="bookFormData.genre" 
            placeholder="Enter book genre (e.g., Fiction, Mystery, Science)">
        </div>
        
        <div class="form-group">
          <label for="description">Description</label>
          <textarea 
            id="description" 
            name="description"
            [(ngModel)]="bookFormData.synopsis" 
            rows="5"
            placeholder="Enter book description"></textarea>
        </div>
        
        <div class="form-group">
          <label for="image">Cover Image URL</label>
          <input 
            type="text" 
            id="image" 
            name="image"
            [(ngModel)]="bookFormData.coverUrl" 
            [readonly]="isCoverUrlFromApi"
            placeholder="Enter image URL">
          <div class="image-preview" *ngIf="bookFormData.coverUrl">
            <img [src]="bookFormData.coverUrl" alt="Preview" (error)="bookFormData.coverUrl = ''">
          </div>
        </div>

        <div class="form-group checkboxes-group">
          <label class="checkbox-container">
            <input 
              type="checkbox" 
              name="favourite"
              [(ngModel)]="bookFormData.favourite">
            <span class="checkbox-label">‚ù§Ô∏è Mark as Favourite</span>
          </label>
          
          <label class="checkbox-container">
            <input 
              type="checkbox" 
              name="read"
              [(ngModel)]="bookFormData.read">
            <span class="checkbox-label">üìñ Mark as Read</span>
          </label>
          
          <label class="checkbox-container">
            <input 
              type="checkbox" 
              name="shareable"
              [(ngModel)]="bookFormData.shareable">
            <span class="checkbox-label">üîó Shareable</span>
          </label>
          
          <label class="checkbox-container">
            <input 
              type="checkbox" 
              name="archived"
              [(ngModel)]="bookFormData.archived">
            <span class="checkbox-label">üì¶ Archived</span>
          </label>
        </div>

        <div class="error-message" *ngIf="error">
          {{ error }}
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn-cancel" (click)="close()">Cancel</button>
          <button 
            type="submit" 
            class="btn-submit" 
            [disabled]="!this.bookFormData.authorName || !this.bookFormData.title">
            {{ submitButtonText }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
